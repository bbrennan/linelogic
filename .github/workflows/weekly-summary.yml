name: LineLogic Weekly Summary

on:
    schedule:
        - cron: "0 9 * * 1" # Mondays at 9:00 AM UTC
    workflow_dispatch:

jobs:
    weekly-summary:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .

            - name: Get week end date (UTC)
              id: dates
              run: |
                  END_DATE=$(date -u +%Y-%m-%d)
                  echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
                  echo "End date: $END_DATE"

            - name: Run POC validation and email report
              env:
                  SMTP_USER: ${{ secrets.SMTP_USER }}
                  SMTP_PASS: ${{ secrets.SMTP_PASS }}
                  FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
                  TO_EMAIL: ${{ secrets.TO_EMAIL }}
              run: |
                  python scripts/validate_predictions.py \
                    --predictions docs/status/predictions_log.csv \
                    --by-tier --by-team --by-bucket \
                    --export-json docs/status/reports/validation_report_${{ steps.dates.outputs.end_date }}.json \
                    --export-csv docs/status/reports/tier_metrics_${{ steps.dates.outputs.end_date }}.csv

            - name: Send validation email
              env:
                  SMTP_USER: ${{ secrets.SMTP_USER }}
                  SMTP_PASS: ${{ secrets.SMTP_PASS }}
                  FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
                TO_EMAIL: ${{ secrets.TO_EMAIL }}
              run: |
                  python scripts/send_weekly_email.py ${{ steps.dates.outputs.end_date }}

            - name: Legacy - Run weekly-summary (if exists)
              env:
                  SMTP_USER: ${{ secrets.SMTP_USER }}
                  SMTP_PASS: ${{ secrets.SMTP_PASS }}
                  FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
                  TO_EMAIL: ${{ secrets.TO_EMAIL }}
              continue-on-error: true
              run: |
                  if [ -n "${TO_EMAIL:-}" ]; then
                    python -m linelogic.app.cli weekly-summary --date ${{ steps.dates.outputs.end_date }} --email "$TO_EMAIL" 2>/dev/null || true
                  else
                    python -m linelogic.app.cli weekly-summary --date ${{ steps.dates.outputs.end_date }} --no-email 2>/dev/null || true
                  fi

            - name: Commit validation reports
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "LineLogic Bot"

                  git add docs/status/reports/validation_report_*.json docs/status/reports/tier_metrics_*.csv 2>/dev/null || true

                  if git diff --cached --quiet; then
                    echo "No validation reports to commit"
                  else
                    git commit -m "chore: Add weekly validation report (${{ steps.dates.outputs.end_date }})"
                    git push
                  fi
              continue-on-error: true

            - name: Upload validation artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: linelogic-validation-${{ steps.dates.outputs.end_date }}
                  path: |
                  docs/status/reports/validation_report_*.json
                  docs/status/reports/tier_metrics_*.csv
                  retention-days: 30
